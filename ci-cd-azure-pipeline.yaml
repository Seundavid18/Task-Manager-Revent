trigger:
- main

pool:
  vmImage: 'ubuntu-latest'

variables:
- group: revent-task-api-group
- name: IMAGE_TAG
  value: "$(Build.BuildId)" 

stages:
- stage: Build
  displayName: "Build and Push Docker Image"
  jobs:
  - job: BuildAndPush
    steps:
    - task: Docker@2
      displayName: "Login to Azure Container Registry"
      inputs:
        command: login
        containerRegistry: "$(ACR_SERVICE_CONNECTION)"

    - task: Docker@2
      displayName: "Build and Push Docker Image"
      inputs:
        command: buildAndPush
        repository: "$(ACR_NAME).azurecr.io/$(IMAGE_NAME)"
        dockerfile: api/Dockerfile
        tags: "$(IMAGE_TAG)"
 
    - task: PublishBuildArtifacts@1
      displayName: "Publish Kubernetes Manifests"
      inputs:
        pathToPublish: '$(Build.SourcesDirectory)/k8s'
        artifactName: manifests

- stage: Deploy
  displayName: "Deploy to AKS"
  jobs:
  - job: DeployToK8s
    steps:
    - task: AzureCLI@2
      displayName: "Set Kubernetes Context"
      inputs:
        azureSubscription: "$(AZ_SERVICE_CONNECTION)"
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          az aks get-credentials --resource-group $(RESOURCE_GROUP) --name $(CLUSTER_NAME)

    - task: DownloadPipelineArtifact@2
      displayName: "Download Kubernetes Manifests"
      inputs:
        artifactName: 'manifests'
        downloadPath: '$(Build.SourcesDirectory)/k8s'

    - task: KubernetesManifest@1
      displayName: "Deploy Application to AKS"
      inputs:
        action: 'deploy'
        connectionType: 'kubernetesServiceConnection'
        kubernetesServiceConnection: "$(K8S_SERVICE_ENDPOINT)"
        namespace: 'revent-task'
        manifests: |
          $(Build.SourcesDirectory)/k8s/deployment.yaml
          $(Build.SourcesDirectory)/k8s/service.yaml
        containers: "$(ACR_NAME).azurecr.io/$(IMAGE_NAME):$(IMAGE_TAG)"
        overrideValues: |
          env.MONGO_URI=$(MONGO_URI)

    - task: AzureCLI@2
      displayName: "Deploy Prometheus Manually"
      inputs:
        azureSubscription: "$(AZ_SERVICE_CONNECTION)"
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          kubectl apply -f https://raw.githubusercontent.com/prometheus-operator/kube-prometheus/main/manifests/setup/
          kubectl apply -f https://raw.githubusercontent.com/prometheus-operator/kube-prometheus/main/manifests/